//@version=5
indicator("AMT Hybrid Trading System", "AMT-Hybrid", true, max_bars_back=500)

// ========================================================
// === AUCTION MARKET THEORY (AMT) HYBRID INDICATOR ===
// Optimized for European Trading Sessions (UTC+1)
// 
// === AI INTEGRATION CAPABILITIES ===
// 
// CURRENT STATE: AI Integration is prepared but not active
// - Pine Script v5 does not support direct API calls to external services
// - All AI functions are implemented as placeholders for future use
// - When TradingView enables external API access, Gemini integration can be added
// 
// WORKAROUND SOLUTION:
// 1. Create external service (Node.js/Python) that calls Gemini API
// 2. Host service and expose via TradingView's data feed capabilities
// 3. Use request.security() to receive AI analysis results
// 
// AI INPUT DATA PREPARED:
// - Market data formatting function ready
// - Signal combination logic prepared
// - UI elements updated to show AI status
// 
// ========================================================

// === INPUTS ===
// Session Settings
enable_alerts = input.bool(true, "Enable Trading Alerts", group="ðŸŽ¯ Alerts")
enable_hybrid_mode = input.bool(true, "Enable Hybrid Mode", group="âš¡ Mode")
enable_minimal_mode = input.bool(false, "Enable Minimal Mode (No AI)", group="âš¡ Mode")
enable_ai_analysis = input.bool(false, "Enable AI Analysis (External Service)", group="ðŸ¤– AI Integration")
api_endpoint = input.string("", "AI API Endpoint", tooltip="URL to your external AI service", group="ðŸ¤– AI Integration")
api_key = input.string("", "API Key", tooltip="Your AI service API key", group="ðŸ¤– AI Integration")
show_fair_value_gaps = input.bool(true, "Show Fair Value Gaps", group="ðŸ›¡ï¸ AMT Features")
show_volume_profile = input.bool(true, "Show Volume Profile", group="ðŸ›¡ï¸ AMT Features")
show_market_structure = input.bool(true, "Show Market Structure", group="ðŸ›¡ï¸ AMT Features")
show_sessions = input.bool(true, "Show Trading Sessions", group="ðŸŒ Sessions")

// Risk Management
rsi_length = input.int(14, "RSI Length", minval=1, group="ðŸ“Š Technical")
macd_fast = input.int(12, "MACD Fast", minval=1, group="ðŸ“Š Technical")
macd_slow = input.int(26, "MACD Slow", minval=1, group="ðŸ“Š Technical")
macd_signal = input.int(9, "MACD Signal", minval=1, group="ðŸ“Š Technical")

// Volume Profile Settings
vp_range_bars = input.int(200, "Volume Profile Range", minval=50, maxval=500, group="ðŸ“ˆ Volume")
vp_bins = input.int(20, "Volume Profile Bins", minval=10, maxval=50, group="ðŸ“ˆ Volume")

// ========================================================
// === CORE FUNCTIONS ===
// ========================================================

// Get current trading session (optimized for European timezone)
get_trading_session() =>
    current_hour = hour
    current_minute = minute
    current_time = current_hour * 60 + current_minute
    
    // Weekend check
    if dayofweek == dayofweek.saturday or dayofweek == dayofweek.sunday
        "weekend"
    // Pre-London (01:00-07:00 CET = 00:00-06:00 UTC)
    else if current_time >= 0 and current_time < 360
        "pre_london"
    // London session (07:00-10:00 CET = 06:00-09:00 UTC)
    else if current_time >= 360 and current_time < 540
        "london"
    // London-NY Overlap (10:00-15:00 CET = 09:00-14:00 UTC)
    else if current_time >= 540 and current_time < 840
        "london_ny_overlap"
    // New York (15:00-19:00 CET = 14:00-18:00 UTC)
    else if current_time >= 840 and current_time < 1080
        "new_york"
    // Post-NY (19:00-01:00 CET = 18:00-00:00 UTC)
    else
        "post_ny"

// Session-based frequency configuration
get_session_config(session) =>
    switch session
        "weekend" => [180, "minimal", color.new(color.gray, 80)]
        "pre_london" => [90, "minimal", color.new(color.yellow, 70)]
        "london" => [30, "minimal", color.new(color.orange, 50)]
        "london_ny_overlap" => [15, "signal", color.new(color.red, 30)]
        "new_york" => [20, "signal", color.new(color.purple, 40)]
        "post_ny" => [60, "minimal", color.new(color.blue, 60)]
        => [60, "minimal", color.new(color.gray, 80)]

// Calculate Fair Value Gaps (FVG)
calculate_fvg(high_price, low_price, high_prev, low_prev, high_next, low_next) =>
    bullish_fvg = low_price > high_prev and high_price < low_next
    bearish_fvg = high_price < low_prev and low_price > high_next
    [bullish_fvg, bearish_fvg]

// Calculate Enhanced Volume Profile
calculate_volume_profile(high_arr, low_arr, close_arr, vol_arr) =>
    // Initialize variables at function scope - this is crucial for Pine Script v5
    var poc_val = na
    var val_high_val = na
    var val_low_val = na
    var max_volume_idx_local = 0
    var max_volume = 0.0
    var bin_size = 0.0
    var price_range = 0.0
    var total_volume = 0.0
    var total_vol = 0.0
    var target_volume = 0.0
    var current_volume = 0.0
    var temp_max_volume_idx = 0
    var volume_at_price = array.new<float>()
    var price_levels = array.new<float>()
    
    if barstate.islast
        array.clear(volume_at_price)
        array.clear(price_levels)
        
        price_range := array.size(high_arr) > 0 ? array.get(high_arr, 0) - array.get(low_arr, 0) : 0
        if price_range > 0
            bin_size := price_range / vp_bins
            for i = 0 to vp_bins - 1
                price_level = array.get(low_arr, 0) + (i * bin_size)
                total_volume := 0.0
                for j = 0 to array.size(close_arr) - 1
                    if array.get(close_arr, j) >= price_level and array.get(close_arr, j) < price_level + bin_size
                        total_volume += array.get(vol_arr, j)
                array.push(volume_at_price, total_volume)
                array.push(price_levels, price_level)
            
            max_volume := 0.0
            temp_max_volume_idx := 0
            for i = 0 to array.size(volume_at_price) - 1
                if array.get(volume_at_price, i) > max_volume
                    max_volume := array.get(volume_at_price, i)
                    temp_max_volume_idx := i
            
            if array.size(price_levels) > 0
                poc_val := array.get(price_levels, temp_max_volume_idx)
                max_volume_idx_local := temp_max_volume_idx
        
        total_vol := 0.0
        for i = 0 to array.size(volume_at_price) - 1
            total_vol += array.get(volume_at_price, i)
        
        target_volume := total_vol * 0.70
        current_volume := 0.0
        val_low_val := poc_val
        val_high_val := poc_val
        
        if total_vol > 0
            for i = 0 to array.size(volume_at_price) - 1
                if current_volume < target_volume
                    if i <= max_volume_idx_local
                        val_low_val := array.get(price_levels, i)
                    if i >= max_volume_idx_local
                        val_high_val := array.get(price_levels, i)
                    current_volume := array.get(volume_at_price, i)
    
    [poc_val, val_high_val, val_low_val]

// Detect market state (Balance vs Imbalance)
detect_market_state(high_price, low_price, close_price, vol_data, poc, val_high, val_low) =>
    current_session = get_trading_session()
    in_value_area = close_price >= val_low and close_price <= val_high
    
    balance_score = 0
    imbalance_score = 0
    
    if not na(poc)
        if in_value_area
            balance_score += 2
        else
            imbalance_score += 2
    
    if not na(vol_data)
        vol_ma_20 = ta.sma(vol_data, 20)
        if vol_data > vol_ma_20 * 1.5
            imbalance_score += 1
        else if vol_data < vol_ma_20 * 0.7
            balance_score += 1
    
    range_value = high_price - low_price
    range_ma_20 = ta.sma(range_value, 20)
    range_expansion = range_ma_20 > 0 ? range_value / range_ma_20 : 1
    if range_expansion > 1.3
        imbalance_score += 1
    else if range_expansion < 0.8
        balance_score += 1
    
    if imbalance_score > balance_score
        "imbalance"
    else if balance_score > imbalance_score
        "balance"
    else
        "neutral"

// Calculate aggression score
calculate_aggression_score(vol_data, price_range) =>
    if not na(vol_data)
        avg_volume = ta.sma(vol_data, 20)
        vol_spike = avg_volume > 0 ? vol_data / avg_volume : 1
        range_ma = ta.sma(price_range, 20)
        range_factor = range_ma > 0 ? price_range / range_ma : 1
        math.min(100, vol_spike * 50 + range_factor * 25)
    else
        0

// === AI INTEGRATION PLACEHOLDERS ===
// NOTE: Currently Pine Script v5 does not support external API calls
// These functions are prepared for future TradingView API capabilities

// Prepare market data for AI analysis
prepare_ai_market_data() =>
    // Format current market data for AI processing
    market_data = "Current Price: " + str.tostring(close) + "\n"
    market_data += "RSI: " + str.tostring(math.round(rsi, 2)) + "\n"
    market_data += "MACD: " + str.tostring(math.round(macd_line, 4)) + "\n"
    market_data += "Volume: " + str.tostring(volume) + "\n"
    market_data += "Market State: " + market_state + "\n"
    market_data += "Trading Session: " + current_session + "\n"
    market_data += "Aggression Score: " + str.tostring(math.round(aggression_score)) + "%"
    market_data

// AI Analysis Function (Future Implementation)
perform_ai_analysis(market_data) =>
    // TODO: When TradingView enables external API calls, implement:
    // - Send market_data to Gemini API
    // - Process AI response for trading signals
    // - Return AI-powered buy/sell recommendations
    
    // For now, return neutral signal
    "HOLD"

// Current AI Analysis Result (Placeholder)
ai_signal = enable_ai_analysis ? perform_ai_analysis(prepare_ai_market_data()) : "AI_DISABLED"

// Enhanced AI Analysis for Hybrid Mode
get_ai_enhanced_signal() =>
    if not enable_ai_analysis or api_endpoint == "" or api_key == ""
        // Return traditional analysis if AI is disabled
        buy_signal or sell_signal ? (buy_signal ? "BUY" : "SELL") : "HOLD"
    else
        // Future: Combine traditional analysis with AI insights
        // ai_enhanced_signal = combine_traditional_ai_signals(traditional_signal, ai_analysis)
        // For now, fall back to traditional analysis
        buy_signal or sell_signal ? (buy_signal ? "BUY" : "SELL") : "HOLD"

// ========================================================
// === DATA COLLECTION ===
// ========================================================

var array<float> high_history = array.new<float>()
var array<float> low_history = array.new<float>()
var array<float> close_history = array.new<float>()
var array<float> volume_history = array.new<float>()

array.push(high_history, high)
array.push(low_history, low)
array.push(close_history, close)
array.push(volume_history, volume)

if array.size(high_history) > vp_range_bars
    array.shift(high_history)
    array.shift(low_history)
    array.shift(close_history)
    array.shift(volume_history)

// ========================================================
// === TECHNICAL INDICATORS ===
// ========================================================

rsi = ta.rsi(close, rsi_length)
[macd_line, signal_line, _] = ta.macd(close, macd_fast, macd_slow, macd_signal)

// Calculate SMA values separately to avoid function call warnings
vol_ma_short = ta.sma(volume, 5)
vol_ma_long = ta.sma(volume, 20)

volume_spike = volume > vol_ma_short * 2
volume_trend = vol_ma_short > vol_ma_long ? "increasing" : "decreasing"

// ========================================================
// === AMT CALCULATIONS ===
// ========================================================

[bullish_fvg, bearish_fvg] = calculate_fvg(high, low, high[1], low[1], high[2], low[2])
[poc, val_high, val_low] = calculate_volume_profile(high_history, low_history, close_history, volume_history)
market_state = detect_market_state(high, low, close, volume, poc, val_high, val_low)
current_session = get_trading_session()
[frequency, session_mode, session_color] = get_session_config(current_session)
aggression_score = calculate_aggression_score(volume, high - low)

// ========================================================
// === SIGNAL GENERATION ===
// ========================================================

bullish_fvg_zone = bullish_fvg and market_state == "imbalance" and current_session == "london_ny_overlap"
price_below_poc = close < poc and not na(poc)
increasing_volume = volume_trend == "increasing"
high_aggression = aggression_score > 60

bearish_fvg_zone = bearish_fvg and market_state == "imbalance" and current_session == "london_ny_overlap"
price_above_poc = close > poc and not na(poc)

price_above_val = close > val_high and not na(val_high)
price_below_val = close < val_low and not na(val_low)
market_balance = market_state == "balance"

long_signal = bullish_fvg_zone and price_below_poc and increasing_volume and (rsi < 70)
short_signal = bearish_fvg_zone and price_above_poc and increasing_volume and (rsi > 30)
mean_revert_long = market_balance and price_below_val and rsi < 40
mean_revert_short = market_balance and price_above_val and rsi > 60

buy_signal = long_signal or mean_revert_long
sell_signal = short_signal or mean_revert_short

// AI-Enhanced Signal Generation
ai_enhanced_signal = get_ai_enhanced_signal()
final_signal = enable_ai_analysis and api_endpoint != "" and api_key != "" ? ai_enhanced_signal : (buy_signal or sell_signal ? (buy_signal ? "BUY" : "SELL") : "HOLD")

// ========================================================
// === VISUALIZATION ===
// ========================================================

plot(rsi, "RSI", color=color.blue, linewidth=2)
hline(70, "RSI Overbought", color=color.red, linestyle=hline.style_dashed)
hline(30, "RSI Oversold", color=color.green, linestyle=hline.style_dashed)

plot(macd_line, "MACD", color=color.blue)
plot(signal_line, "MACD Signal", color=color.red)
barcolor(macd_line > signal_line ? color.green : color.red, title="MACD Momentum")

if show_fair_value_gaps
    if bullish_fvg
        box.new(bar_index-1, low, bar_index+3, high, bgcolor=color.new(color.green, 90), border_color=color.green, border_width=2)
    if bearish_fvg
        box.new(bar_index-1, low, bar_index+3, high, bgcolor=color.new(color.red, 90), border_color=color.red, border_width=2)

if show_volume_profile and not na(poc)
    line.new(bar_index - vp_range_bars, poc, bar_index, poc, color=color.yellow, width=2, style=line.style_solid)
    if not na(val_high)
        line.new(bar_index - vp_range_bars, val_high, bar_index, val_high, color=color.orange, width=1, style=line.style_dashed)
    if not na(val_low)
        line.new(bar_index - vp_range_bars, val_low, bar_index, val_low, color=color.orange, width=1, style=line.style_dashed)

if show_market_structure
    var float last_swing_high = na
    var float last_swing_low = na
    var int swing_high_bar = na
    var int swing_low_bar = na
    
    if high > high[1] and high > high[2] and high > high[3] and high > high[4]
        last_swing_high := high
        swing_high_bar := bar_index
    if low < low[1] and low < low[2] and low < low[3] and low < low[4]
        last_swing_low := low
        swing_low_bar := bar_index
    
    if not na(last_swing_high) and bar_index - swing_high_bar < 50
        line.new(swing_high_bar, last_swing_high, bar_index, last_swing_high, color=color.red, style=line.style_dashed)
    if not na(last_swing_low) and bar_index - swing_low_bar < 50
        line.new(swing_low_bar, last_swing_low, bar_index, last_swing_low, color=color.green, style=line.style_dashed)

bg_color_final = show_sessions ? session_color : na
bgcolor(bg_color_final, title="Trading Session")

// ========================================================
// === ALERTS ===
// ========================================================

alertcondition(buy_signal, "AMT Long Signal", "AMT Long Signal: {{ticker}} - {{interval}} - Price: {{close}}")
alertcondition(sell_signal, "AMT Short Signal", "AMT Short Signal: {{ticker}} - {{interval}} - Price: {{close}}")
alertcondition(volume_spike, "Volume Spike", "Volume Spike Detected on {{ticker}} - Volume: {{volume}}")
alertcondition(bullish_fvg, "Bullish FVG", "Bullish Fair Value Gap Detected on {{ticker}} - Price: {{close}}")
alertcondition(bearish_fvg, "Bearish FVG", "Bearish Fair Value Gap Detected on {{ticker}} - Price: {{close}}")

// AI-Enhanced Alerts (Future Implementation)
alertcondition(enable_ai_analysis and final_signal == "BUY", "AI-Enhanced Buy Signal", "AI-Enhanced Buy Signal: {{ticker}} - {{interval}} - Price: {{close}} - AI Analysis Enabled")
alertcondition(enable_ai_analysis and final_signal == "SELL", "AI-Enhanced Sell Signal", "AI-Enhanced Sell Signal: {{ticker}} - {{interval}} - Price: {{close}} - AI Analysis Enabled")

// ========================================================
// === LABELS & STATUS ===
// ========================================================

if barstate.islast
    var label session_label = na
    label.delete(session_label)
    session_text = "Session: " + current_session + " | Mode: " + session_mode + " | Freq: " + str.tostring(frequency) + "min | State: " + market_state + " | Agr: " + str.tostring(math.round(aggression_score))
    session_label := label.new(bar_index + 5, high, text=session_text, style=label.style_label_left, color=session_color, textcolor=color.white, size=size.small)

if buy_signal
    label.new(bar_index, low, "BUY", style=label.style_label_up, color=color.green, textcolor=color.white, size=size.normal)

if sell_signal
    label.new(bar_index, high, "SELL", style=label.style_label_down, color=color.red, textcolor=color.white, size=size.normal)

// ========================================================
// === TABLE WITH REAL-TIME INFO ===
// ========================================================

if barstate.islast
    var table info_table = table.new(position.top_right, 2, 9, bgcolor=color.new(color.black, 80), border_width=1)
    table.cell(info_table, 0, 0, "Current Session", text_color=color.white, bgcolor=color.new(session_color, 50))
    table.cell(info_table, 1, 0, current_session, text_color=color.white)
    table.cell(info_table, 0, 1, "Mode", text_color=color.white, bgcolor=color.new(session_color, 50))
    table.cell(info_table, 1, 1, session_mode, text_color=color.white)
    table.cell(info_table, 0, 2, "Market State", text_color=color.white, bgcolor=color.new(session_color, 50))
    table.cell(info_table, 1, 2, market_state, text_color=color.white)
    table.cell(info_table, 0, 3, "RSI", text_color=color.white, bgcolor=color.new(session_color, 50))
    table.cell(info_table, 1, 3, str.tostring(math.round(rsi, 2)), text_color=color.white)
    table.cell(info_table, 0, 4, "Aggression", text_color=color.white, bgcolor=color.new(session_color, 50))
    table.cell(info_table, 1, 4, str.tostring(math.round(aggression_score)) + "%", text_color=color.white)
    table.cell(info_table, 0, 5, "Volume Trend", text_color=color.white, bgcolor=color.new(session_color, 50))
    table.cell(info_table, 1, 5, volume_trend, text_color=color.white)
    price_poc_relation = not na(poc) ? str.tostring(math.round((close - poc) / poc * 100, 2)) + "%" : "N/A"
    table.cell(info_table, 0, 6, "Price vs POC", text_color=color.white, bgcolor=color.new(session_color, 50))
    table.cell(info_table, 1, 6, price_poc_relation, text_color=color.white)
    signal_text = final_signal
    table.cell(info_table, 0, 7, "ðŸŽ¯ Signal", text_color=color.white, bgcolor=color.new(session_color, 50))
    table.cell(info_table, 1, 7, signal_text, text_color=final_signal == "BUY" ? color.green : final_signal == "SELL" ? color.red : color.gray)
    ai_status = enable_ai_analysis and api_endpoint != "" and api_key != "" ? "AI_ENABLED" : "AI_DISABLED"
    table.cell(info_table, 0, 8, "ðŸ¤– AI Status", text_color=color.white, bgcolor=color.new(session_color, 50))
    table.cell(info_table, 1, 8, ai_status, text_color=ai_status == "AI_ENABLED" ? color.yellow : color.gray)

// ========================================================
// === HYBRID MODE OPTIMIZATION ===
// ========================================================

if enable_hybrid_mode
    volume_spike_threshold = 1.5
    aggression_threshold = 50
    
    if current_session == "london_ny_overlap" or current_session == "new_york"
        volume_spike_threshold := 1.5
        aggression_threshold := 50
    else
        volume_spike_threshold := 2.0
        aggression_threshold := 70
    
    long_signal := bullish_fvg_zone and price_below_poc and increasing_volume and (rsi < 70) and (aggression_score > aggression_threshold)
    short_signal := bearish_fvg_zone and price_above_poc and increasing_volume and (rsi > 30) and (aggression_score > aggression_threshold)
    buy_signal := long_signal or (mean_revert_long and aggression_score > 40)
    sell_signal := short_signal or (mean_revert_short and aggression_score > 40)

// ========================================================
// === MINIMAL MODE LOGIC (CALCULATED LOCALLY) ===
// ========================================================

// Minimal mode uses simple logic based on current market data
// No API calls to Gemini - completely free to run frequently

// Calculate simple bias based on local data
simple_action = "HOLD"
if close > close[1] and rsi > 50 and volume > vol_ma_short
    simple_action := "BUY"
else if close < close[1] and rsi < 50 and volume > vol_ma_short
    simple_action := "SELL"

// Calculate simple entry/exit levels
simple_entry = close
simple_stop = simple_action == "BUY" ? close * 0.985 : close * 1.015  // 1.5% stops
simple_target = simple_action == "BUY" ? close * 1.03 : close * 0.97  // 3% targets

// Calculate simple conviction score
simple_conviction = 50
if math.abs(rsi - 50) > 20  // RSI in overbought/oversold territory
    simple_conviction := 70
if volume_spike
    simple_conviction := simple_conviction + 10

// Format simple reasoning
simple_reasoning = "1H: " + str.tostring(math.round(((close - close[60]) / close[60]) * 100, 2)) + "% | RSI: " + str.tostring(math.round(rsi, 1)) + " | Vol: " + (volume_trend == "increasing" ? "â†‘" : "â†“") + " | MA: " + (close > ta.sma(close, 20) ? "BULL" : "BEAR")

// Display minimal mode signals when enabled
if enable_minimal_mode
    minimal_buy_signal = simple_action == "BUY"
    minimal_sell_signal = simple_action == "SELL"
    minimal_hold_signal = simple_action == "HOLD"
    
    if minimal_buy_signal
        label.new(bar_index, low * 0.995, "MIN BUY", style=label.style_label_up, color=color.new(color.green, 20), textcolor=color.white, size=size.small)
    if minimal_sell_signal
        label.new(bar_index, high * 1.005, "MIN SELL", style=label.style_label_down, color=color.new(color.red, 20), textcolor=color.white, size=size.small)